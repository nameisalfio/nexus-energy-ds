flowchart TD
    %% --- CLASS DEFINITIONS ---
    classDef component fill:#ffffff,stroke:#333,stroke-width:1px,color:black
    classDef db fill:#ffffff,stroke:#ef6c00,stroke-width:2px,color:black
    classDef pattern fill:#fce4ec,stroke:#c2185b,stroke-width:1px,stroke-dasharray: 5 5,color:#880e4f
    classDef logging fill:#ffffff,stroke:#fbc02d,stroke-width:2px,color:black
    classDef frontend fill:#61dafb,stroke:#20232a,stroke-width:2px,color:black
    classDef queue fill:#ffffff,stroke:#7b1fa2,stroke-width:2px,color:black
    classDef container fill:#f5f5f5,stroke:#666,stroke-width:2px

    %% --- FRONTEND ENVIRONMENT ---
    subgraph Browser_Env ["üíª Browser"]
        direction TB
        User((User))
        ReactApp("‚öõÔ∏è React + TypeScript<br/>"):::frontend
        User ==> ReactApp
    end

    %% --- BACKEND ENVIRONMENT ---
    subgraph Docker_Host ["üê≥ Docker Environment"]
        direction TB

        %% 1. CLIENT SERVICE (Top Layer)
        subgraph Client_App ["üü¶ Client Service : 8080"]
            direction TB
            UI_Controller[API Controller]:::component
            Authenticator[üîê Token Validation]:::component
            Gateway[EnergyGatewayService]:::component
            CB_Client[‚ö° Circuit Breaker]:::pattern

            UI_Controller --> Authenticator
            Authenticator --> Gateway
            Gateway --"Protects"--> CB_Client
        end

        %% 2. SERVER SERVICE (Middle Layer)
        subgraph Server_App ["üü© Server Service : 8081"]
            direction TB
            Auth[üîê Token Validation]:::pattern
            Facade[Remote Facade API]:::pattern
            
            subgraph Business_Logic ["Business Logic"]
                direction TB
                Service[Energy Analysis Service]:::component
                AI[AI Model Service]:::component
                Batch[üìÑ Request Batch Handler]:::pattern
            end
            
            CB_Database[‚ö° Database Circuit Breaker]:::pattern
            Repo[Energy Repository]:::component
            ModelFile{{AI Model .zip}}:::db

            Auth --> Facade
            Facade --> Service
            Service --> AI
            Service --"Batch Insert"--> Batch
            
            %% Flow AI Interno
            AI --> LSTM[LSTM Network]:::component
            LSTM -.->|"Load"| ModelFile

            %% Accesso Dati
            Batch --"Protects"--> CB_Database
            CB_Database --> Repo
        end

        %% 3. INFRASTRUCTURE SERVICES (Bottom Layer)
        %% Li definiamo qui sotto per forzare il layout in basso
        
        subgraph Messaging_Service ["üì® Msg Service : 5672"]
            RabbitMQ[RabbitMQ Queue]:::queue
        end

        subgraph Data_Service ["üóÑÔ∏è Data Service : 8082"]
            MySQL[(MySQL)]:::db
        end

        subgraph ELK_Stack ["üüß ELK Stack : 5601"]
            direction TB
            Logstash[Logstash]:::logging
            Elasticsearch[Elasticsearch]:::logging
            Kibana[Kibana]:::logging
            
            Logstash --> Elasticsearch --> Kibana
        end
    end

    %% --- CROSS-BOUNDARY CONNECTIONS ---
    
    %% Browser -> Client
    ReactApp == "1. HTTP REST" ==> UI_Controller
    
    %% Client -> Server
    CB_Client == "2. REST JSON" ==> Auth
    
    %% Server -> Data
    Repo == "3. JPA / JDBC" ==> MySQL
    
    %% Server -> Messaging (Async)
    AI -.->|"Publish Anomaly"| RabbitMQ

    %% Logging Flows (Tratteggiati per chiarezza)
    Client_App -.-> |"Logs"| Logstash
    Server_App -.-> |"Logs"| Logstash

    %% --- LAYOUT OPTIMIZATION (Invisible Links) ---
    %% Questi link invisibili forzano l'ordine verticale dei container
    Browser_Env ~~~ Client_App
    Client_App ~~~ Server_App
    Server_App ~~~ Data_Service
    Server_App ~~~ Messaging_Service
    Server_App ~~~ ELK_Stack

    %% --- STYLES ---
    style Browser_Env fill:#e3f2fd,stroke:#2196f3,stroke-width:2px,stroke-dasharray: 5 5
    style Docker_Host fill:#f5f5f5,stroke:#666,stroke-width:2px
    style Client_App fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    style Server_App fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    style Data_Service fill:#ffe0b2,stroke:#ef6c00,stroke-width:2px
    style Messaging_Service fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style ELK_Stack fill:#fff9c4,stroke:#fbc02d,stroke-width:2px
    style Business_Logic fill:#fffff,stroke:#999,stroke-width:1px,stroke-dasharray: 5 5

    linkStyle 13,14 stroke:#fbc02d,stroke-width:2px,stroke-dasharray: 3 3;