flowchart TD
    %% --- CLASS DEFINITIONS ---
    classDef component fill:#ffffff,stroke:#333,stroke-width:1px,color:black
    classDef db fill:#ffffff,stroke:#ef6c00,stroke-width:2px,color:black
    classDef pattern fill:#fce4ec,stroke:#c2185b,stroke-width:1px,stroke-dasharray: 5 5,color:#880e4f
    classDef logging fill:#ffffff,stroke:#fbc02d,stroke-width:2px,color:black

    User((User / Browser))

    subgraph Docker_Host ["ðŸ³ Docker Environment"]
        direction TB

        %% --- CLIENT MICROSERVICE (BFF) ---
        subgraph Client_App ["ðŸŸ¦ Client Service : 8080"]
            direction TB
            
            UI_Controller[Controller]:::component
            Authenticator[ðŸ” Token Validation]:::component
            Gateway[EnergyGatewayService]:::component
            CB_Client[âš¡ Circuit Breaker & Timeout]:::pattern
            
            %% Link 0
            UI_Controller --"Delegates"--> Authenticator
            %% Link 1
            Authenticator --> Gateway
            %% Link 2
            Gateway --"Protects"--> CB_Client
        end

        %% --- SERVER MICROSERVICE (CORE) ---
        subgraph Server_App ["ðŸŸ© Server Service : 8081"]
            direction TB
            
            Auth[ðŸ” Token Validation]:::pattern
            Facade[Remote Facade API]:::pattern
            
            subgraph Business_Logic ["Business Logic"]
                Service[Energy Analysis Service]:::component
                AI[AI Model Service]:::component
                Batch[ðŸ“„ Request Batch Handler]:::pattern
            end
            
            CB_Database[âš¡ Database Circuit Breaker]:::pattern
            Repo[Energy Repository]:::component
            
            %% Link 3
            Auth --> Facade
            %% Link 4
            Facade --> Service
            
            %% Flussi Logici
            %% Link 5
            Service --> AI
            %% Link 6
            AI --> LSTM
            %% Link 7
            Service --"Batch Insert"--> Batch
            ModelFile{{AI Model .zip}}:::db
            
            %% Protezione verso il DB
            %% Link 8
            Batch --"Protects"--> CB_Database
            %% Link 9
            CB_Database --> Repo
        end

        %% --- DATA SERVICE ---
        subgraph Data_Service ["ðŸ—„ï¸ Data Service : 8082"]
            MySQL[(MySQL)]:::db
        end

        %% --- ELK STACK ---
        subgraph ELK_Stack ["ðŸŸ§ ELK Stack : 5601"]
            direction TB
            Logstash[Logstash Collector]:::logging
            Elasticsearch[(Elasticsearch DB)]:::logging
            Kibana[Kibana UI]:::logging

            %% Link 10
            Logstash --"Indexing"--> Elasticsearch
            %% Link 11
            Elasticsearch --"Query Data"--> Kibana
        end
    end

    %% --- OPERATIONAL DATA FLOWS ---
    %% Link 12
    User == "1. HTTP / Session Cookie" ==> UI_Controller
    %% Link 13
    CB_Client == "2. REST (JSON) + JWT Token" ==> Auth
    %% Link 14
    Repo == "3. JPA / Hibernate" ==> MySQL
    %% Link 15
    LSTM -.->|"Load Weights"| ModelFile

    %% --- LOGGING FLOWS ---
    %% Link 16
    Client_App -.-> |"Logs"| Logstash
    %% Link 17
    Server_App -.-> |"Logs"| Logstash
    %% Link 18
    Data_Service -.-> |"Logs"| Logstash

    %% --- SUBGRAPH STYLES (COLORI BACKGROUND) ---
    %% Docker Host (Grigio Neutro)
    style Docker_Host fill:#f5f5f5,stroke:#666,stroke-width:2px
    
    %% Client (Azzurro Chiaro)
    style Client_App fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    
    %% Server (Verde Chiaro)
    style Server_App fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    
    %% Data (Arancione Chiaro)
    style Data_Service fill:#ffe0b2,stroke:#ef6c00,stroke-width:2px
    
    %% ELK (Giallo Chiaro)
    style ELK_Stack fill:#fff9c4,stroke:#fbc02d,stroke-width:2px
    
    %% Business Logic interna (Bianco per contrasto)
    style Business_Logic fill:#90EE9,stroke:#999,stroke-width:1px,stroke-dasharray: 5 5

    %% Applicazione stile flussi di log
    linkStyle 16,17,18 stroke:#fbc02d,stroke-width:2px,stroke-dasharray: 3 3;