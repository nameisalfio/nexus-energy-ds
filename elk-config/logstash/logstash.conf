input {
  # Riceve i log da Spring Boot via TCP
  tcp {
    port => 5000
    codec => json_lines
  }
}

filter {
  # 1. Aggiunta timestamp se mancante
  if ![timestamp] {
    mutate { add_field => { "received_at" => "%{@timestamp}" } }
  }

  # 2. Conversione numeri per grafici Kibana (Solo se Ã¨ un'anomalia)
  if [event_type] == "ANOMALY" {
    mutate {
      convert => {
        "anomaly_deviation" => "float"
        "anomaly_actual" => "float"
        "anomaly_predicted" => "float"
      }
    }
  }
}

output {
  # --- 1. SEMPRE: Salva su Elasticsearch ---
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "energy-server-logs-%{+YYYY.MM.dd}"
  }

  # --- 2. ALERT DB (Se il messaggio contiene TELEGRAM_ALERT) ---
  if "DATABASE STRESS" in [message] {
    http {
      url => "https://api.telegram.org/bot8215343257:AAEzjVQqbNVJTpsgUpubQcqfRP9amJn_7Vs/sendMessage"
      http_method => "post"
      content_type => "application/json"
      format => "message"
      message => '{"chat_id": "-5204085463", "parse_mode": "Markdown", "text": "ğŸš¨ *ALLARME ENERGY SYSTEM* ğŸš¨\n\nâš ï¸ *Stato:* Database Irraggiungibile\nğŸ“‰ *Azione:* Dati deviati su RabbitMQ\n\nğŸ‘¤ *Utente:* %{alert_email}\nğŸ“ *Errore:* %{message}"}'
    }
  }

  # --- 3. ALERT ANOMALIA (Se il messaggio contiene ANOMALY_ALERT) ---
  if "ANOMALY_ALERT" in [message] {
    http {
      url => "https://api.telegram.org/bot8215343257:AAEzjVQqbNVJTpsgUpubQcqfRP9amJn_7Vs/sendMessage"
      http_method => "post"
      content_type => "application/json"
      format => "message"
      message => '{"chat_id": "-5204085463", "parse_mode": "Markdown", "text": "ğŸ¤– *AI ANOMALY DETECTED* ğŸ¤–\n\nğŸ“Š *Deviazione:* %{anomaly_deviation}%\nğŸ”® *Previsto:* %{anomaly_predicted} kW\nâš¡ *Reale:* %{anomaly_actual} kW\n\n_Il modello AI ha rilevato un consumo anomalo._"}'
    }
  }

  # --- 4. DEBUG CONSOLE ---
  stdout { codec => rubydebug }
}